## Power Meter 4 Lines (ESPHome)

Проект на ESPHome для измерения тока, напряжения и раздельной активной мощности (import/export) по четырём независимым линиям 220 В.

- **Плата**: ESP32 WROOM-32E (`board: esp32dev`)
- **АЦП**: 2× ADS1115 (1 чип – токи, 1 чип – напряжения)
- **Датчики**: 4× CT 100 A (трансформаторы тока), 4× модуля ZMPT101B (напряжение)
- **Логика**: кастомный компонент `PowerMeter4Lines` на C++ (`power_meter_ads1115_4lines.h`)
- **Конфиг ESPHome**: `power_meter_4lines.yaml`

### Как работает измерение и почему оно точнее простого `V*I`

- **Измеряются не просто RMS‑значения, а форма сигналов**:
  - Для каждой линии пара `U(t)` и `I(t)` снимается с ADS1115 многократно за окно в несколько периодов сети (по умолчанию 20 периодов при 50 Гц).
  - Считаются:
    - средние значения `⟨U⟩`, `⟨I⟩`,
    - дисперсии `Var(U)`, `Var(I)` → RMS,
    - ковариация `Cov(U, I)` → активная мощность.
- **Активная мощность** вычисляется по формуле:
  \[
  P \approx Cov(U, I) \cdot K_U \cdot K_I
  \]
  где \(K_U\) и \(K_I\) – калибровочные коэффициенты для напряжения и тока.
- **Направление мощности (import/export)**:
  - Знак ковариации определяет, идёт ли энергия в нагрузку (import, потребление) или обратно в сеть/инвертор (export, отдача).
  - Это принципиально лучше, чем умножение «одной пары точек» `V_raw * I_raw`, как в простых YAML‑шаблонах.

#### Оценка точности

- При аккуратной калибровке по эталонному счётчику или качественному мультиметру и при стабильной сети:
  - **Ток**: точность порядка нескольких процентов в диапазоне от ~0.1–0.2 А до 32 А.
  - **Напряжение**: точность на уровне 1–2 % (ограничена качеством и калибровкой ZMPT101B).
  - **Активная мощность**: обычно в пределах 3–5 % от эталонного счётчика (для нормальных нагрузок, не очень «грязной» формы).
- Реальная точность сильно зависит от:
  - качества CT 100 A и правильного выбора бёрден‑резистора;
  - качества модулей ZMPT101B и их подстройки;
  - аккуратной калибровки коэффициентов `current_scale` и `voltage_scale`.

### Пины ESP32 и подключение I2C / ADS1115

- **I2C (ESP32 WROOM-32E)**:
  - `GPIO21` → `SDA` обоих ADS1115
  - `GPIO22` → `SCL` обоих ADS1115
  - Подтяжки: по 4.7 kΩ к `3.3 V` на SDA и SCL (если нет на модулях ADS1115).
- **Питание**:
  - ESP32 питается от `5 V` (через свой стабилизатор до `3.3 V`).
  - Оба ADS1115 питаются от `3.3 V` (логика ESP32).
  - Все «земли» (ESP32, ADS1115, стороны ZMPT, вторичные стороны CT) – **общие**.
- **Адреса ADS1115**:
  - Модуль токов: `ADDR` → GND → адрес `0x48` (`id: ads_current`).
  - Модуль напряжений: `ADDR` → `3.3 V` → адрес `0x49` (`id: ads_voltage`).

### Распределение каналов ADS1115

- **ADS1115 @0x48 – токи (CT 100 A)**:
  - `AIN0` → L1 ток
  - `AIN1` → L2 ток
  - `AIN2` → L3 ток
  - `AIN3` → L4 ток
- **ADS1115 @0x49 – напряжения (ZMPT101B)**:
  - `AIN0` → L1 напряжение
  - `AIN1` → L2 напряжение
  - `AIN2` → L3 напряжение
  - `AIN3` → L4 напряжение

### Электрическая схема по одной линии (L1)

#### 1. Трансформатор тока CT 100 A → ADS1115 (ток)

Предполагаем типовой CT 100 A : 50 mA (или близкий по параметрам).

- Один вывод CT → один вывод бёрден‑резистора **R_burden ≈ 22 Ω** (0.5–1 Вт, металлоплёночный).
- Второй вывод CT → второй вывод R_burden.
- Узел 1: **R_burden ↔ Vmid**:
  - Один конец R_burden → виртуальная середина `Vmid ≈ 1.65 V`.
  - Реализация `Vmid`:
    - `3.3 V ─ 100 kΩ ─┬─ 100 kΩ ─ GND`
    - узел между резисторами – это `Vmid`.
    - параллельно `Vmid` → GND: `10 µF` + `100 nF`.
- Узел 2: **R_burden ↔ вход АЦП**:
  - Второй конец R_burden → вход `AIN0` ADS1115 @0x48 (для L1).
  - Желательно добавить:
    - последовательно 100–330 Ω между R_burden и `AIN0`;
    - конденсатор 1–10 nF с `AIN0` на GND (RC‑фильтр от ВЧ‑шума).

Простая ASCII‑схема для тока L1:

```text
   Фаза L1 ────────────────[ Нагрузка ]───────────── N (свой ноль линии)
                 │
                 │
             [ CT 100 A ]
              ~      ~
              |      |
              +------+
                     \
                      )  R_burden ~ 22 Ω
                     /
              +------+
              |      |
           Vmid    AIN0 (ADS1115 @0x48)
```

Где:
- `Vmid` создаётся делителем 100 kΩ / 100 kΩ от 3.3 V, как описано выше.

#### 2. ZMPT101B → ADS1115 (напряжение)

- Вход модуля ZMPT101B:
  - один входной контакт → фаза L1;
  - второй входной контакт → ноль именно этой линии (если нули раздельные – используем её ноль).
- Питание модуля:
  - `+5 V` (от того же БП, что и ESP32);
  - `GND` общая с ESP32/ADS1115.
- Выход `OUT` модуля:
  - через резистор 1 kΩ → вход `AIN0` ADS1115 @0x49;
  - параллельно `AIN0` к GND – конденсатор 1–10 nF.
- Подстроечник ZMPT:
  - при максимальном напряжении сети (250–260 V) амплитуда сигнала на `AIN0` должна быть **существенно меньше 3.3 V** (например, до ~1.5–2 V пик‑пик) – это даёт запас по входу АЦП.

Условная ASCII‑схема для напряжения L1:

```text
Фаза L1 ──────┐
              )  Вход ZMPT101B
Ноль L1 ──────┘

        ZMPT101B module
        +5V ──────────────┐
        GND ──────┬───────┘
                  |
OUT ──[ 1 kΩ ]────┴─── AIN0 (ADS1115 @0x49)
                   |
                 [ 1–10 nF ]
                   |
                  GND
```

### Калибровка (напряжение и ток)

#### 1. Базовая проверка перед калибровкой

1. Сначала проверьте **напряжение сети** нормальным мультиметром на каждой линии L1–L4.
2. Убедитесь, что:
   - CT надеты на **фазные провода**, а не на N или сразу на «фаза+ноль».
   - ZMPT101B подключены к «своей» фазе и нулю.
3. Запустите ESPHome, подключите устройство к Home Assistant и посмотрите, что сенсоры `Lx Voltage` и `Lx Current` вообще показывают какие‑то значения.

#### 2. Калибровка напряжения (voltage_scale)

1. Выберите одну линию (например L1).
2. Измерьте мультиметром реальное напряжение сети `U_real` (например, 230 V).
3. Посмотрите в Home Assistant значение `L1 Voltage` → `U_meas`.
4. В YAML найдите блок:

```yaml
const float voltage_scale = 230.0f;  # В на 1 В входа ADS
```

5. Обновите коэффициент:
   - Новый `voltage_scale_new = voltage_scale_old * (U_real / U_meas)`.
   - Например: `voltage_scale_old = 230`, `U_real = 230`, `U_meas = 210` →
     `voltage_scale_new ≈ 230 * (230/210) ≈ 252`.
6. Перепрошьйте ESP и проверьте `L1 Voltage` ещё раз; добейтесь минимального расхождения.
7. Для остальных линий обычно можно использовать тот же `voltage_scale`, если модули ZMPT одинаковы и подстроены похоже. При необходимости подстроить каждый ZMPT по отдельности (ручным вращением подстроечника).

#### 3. Калибровка тока (current_scale)

1. Подключите к линии L1 известную нагрузку, например:
   - электрический обогреватель/чайник с паспортной мощностью;
   - или нагрузку, для которой можно измерить ток мультиметром (клещами).
2. Измерьте реальный ток `I_real` (А).
3. Считайте из Home Assistant показание `L1 Current` → `I_meas`.
4. В YAML найдите:

```yaml
const float current_scale = 30.0f;  # А на 1 В входа ADS
```

5. Обновите коэффициент:
   - Новый `current_scale_new = current_scale_old * (I_real / I_meas)`.
6. Перепрошьйте ESP и проверьте ещё раз; при необходимости повторите.

#### 4. Проверка мощности и энергии

1. Зная `U_real` и `I_real`, оцените ожидаемую активную мощность `P_real ≈ U_real * I_real * cos φ` (если нагрузка почти активная – cos φ ≈ 1).
2. Сравните `P_real` с `L1 Power Import`:
   - разбежка в пределах 3–5 % для обычной нагрузки – нормальный результат.
3. Для энергии:
   - дайте нагрузке поработать час и сравните изменение `L1 Energy Import` с показаниями отдельного счётчика/элекстросчётчика (если есть).

### Разделение import / export

- Знак активной мощности определяется по фазовому соотношению между `U(t)` и `I(t)`:
  - положительный знак → **import** (потребление от сети/инвертора в нагрузку);
  - отрицательный знак → **export** (отдача от нагрузки/генератора в сеть/инвертор).
- В сенсорах:
  - `Lx Power Import` – активная мощность со знаком `> 0`, иначе 0;
  - `Lx Power Export` – активная мощность со знаком `< 0`, взятая по модулю.
- Накопительные сенсоры `Lx Energy Import` и `Lx Energy Export` считают энергию в kWh отдельно по каждому направлению.

### Файлы проекта

- `power_meter_4lines.yaml` – конфигурация ESPHome для ESP32 WROOM-32E.
- `power_meter_ads1115_4lines.h` – реализация кастомного компонента `PowerMeter4Lines`.
- `README.md` – это описание.

